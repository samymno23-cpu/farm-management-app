<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø¥Ø¯Ø§Ø±Ø© Ù…Ø²Ø§Ø±Ø¹ Ø§Ù„Ø²ÙŠØªÙˆÙ† Ø§Ù„Ø°ÙƒÙŠØ©</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        :root { --primary-color: #4b5d16; --secondary-color: #8b4513; }
        body { background-color: #f8f9fa; font-family: 'Segoe UI', sans-serif; }
        .header-app { background: linear-gradient(135deg, var(--primary-color), #2e3b1a); color: white; padding: 20px; border-radius: 0 0 30px 30px; }
        .card-custom { border-radius: 20px; border: none; box-shadow: 0 5px 15px rgba(0,0,0,0.08); margin-bottom: 15px; }
        .btn-main { border-radius: 12px; margin: 5px; flex: 1 1 30%; font-size: 0.9rem; padding: 10px; }
        .weather-box { background: #e3f2fd; border-radius: 15px; padding: 10px; color: #0d47a1; margin-bottom: 15px; text-align: center; }
        .stock-badge { background: #fff3e0; color: #e65100; padding: 2px 8px; border-radius: 5px; font-size: 0.8rem; }
    </style>
</head>
<body>

<div class="header-app text-center">
    <h4 id="farmNameHead">Ù…Ø²Ø±Ø¹Ø© Ø§Ù„Ø²ÙŠØªÙˆÙ†</h4>
    <div class="d-flex justify-content-center gap-2 mt-2">
        <select id="farmSelector" class="form-select w-50" onchange="loadFarm()">
            </select>
        <button class="btn btn-light btn-sm" onclick="createNewFarm()">+ Ù…Ø²Ø±Ø¹Ø© Ø¬Ø¯ÙŠØ¯Ø©</button>
    </div>
</div>

<div class="container mt-3">
    <div class="weather-box shadow-sm">
        <div class="d-flex justify-content-around align-items-center">
            <a href="https://www.windy.com" target="_blank" class="text-decoration-none">ğŸŒ¤ï¸ Ø¹Ø±Ø¶ Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ù‚Ø³ Ø§Ù„Ø¢Ù†</a>
            <button class="btn btn-sm btn-outline-primary" onclick="setFarmLocation()">ğŸ“ ØªØ­Ø¯ÙŠØ¯ Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ù…Ø²Ø±Ø¹Ø©</button>
        </div>
        <div id="locDisplay" class="small mt-1 text-muted"></div>
    </div>

    <div class="card card-custom p-3">
        <h6 class="fw-bold">ğŸš€ Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… Ø§Ù„Ø³Ø±ÙŠØ¹:</h6>
        <div class="d-flex flex-wrap">
            <button class="btn btn-success btn-main" onclick="openAction('Ø±ÙŠ')">ğŸ’§ Ø±ÙŠ</button>
            <button class="btn btn-warning btn-main text-white" onclick="openAction('ØªØ³Ù…ÙŠØ¯')">ğŸ§ª ØªØ³Ù…ÙŠØ¯</button>
            <button class="btn btn-info btn-main text-white" onclick="openAction('Ø±Ø´')">ğŸ’¨ Ø±Ø´</button>
            <button class="btn btn-danger btn-main" onclick="openAction('ØµÙŠØ§Ù†Ø©')">ğŸ› ï¸ Ø£Ø¹Ø·Ø§Ù„</button>
            <button class="btn btn-primary btn-main" onclick="openAction('ØªØ°ÙƒÙŠØ±')">â° ØªØ°ÙƒÙŠØ± Ø¨Ù…ÙˆØ¹Ø¯</button>
            <button class="btn btn-dark btn-main" onclick="openAction('Ù…Ø®Ø²Ù†')">ğŸ“¦ Ø§Ù„Ù…Ø®Ø²Ù†</button>
        </div>
    </div>

    <div class="card card-custom p-3">
        <h6 class="fw-bold text-danger">â° Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª Ø§Ù„Ù‚Ø§Ø¯Ù…Ø©:</h6>
        <div id="reminderList" class="small"></div>
    </div>

    <div class="card card-custom p-3">
        <h6 class="fw-bold">ğŸ‘¥ Ø¹Ù…Ø§Ù„Ø© Ø§Ù„Ù…Ø²Ø±Ø¹Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©:</h6>
        <div class="table-responsive">
            <table class="table table-sm text-center">
                <thead><tr class="small"><th>Ø§Ù„Ø¹Ø§Ù…Ù„</th><th>Ø­Ø¶ÙˆØ±</th><th>Ø¥Ø¬Ø§Ø²Ø©</th></tr></thead>
                <tbody id="staffList" class="small"></tbody>
            </table>
        </div>
        <button class="btn btn-outline-primary btn-sm w-100" onclick="openAction('Ø¹Ù…Ø§Ù„Ø©')">+ ØªØ³Ø¬ÙŠÙ„ Ø­Ø¶ÙˆØ± Ø¹Ø§Ù…Ù„</button>
    </div>
</div>

<div class="modal fade" id="mainModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content card-custom">
            <div class="modal-header border-0"><h5 id="modalTitle"></h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
            <div class="modal-body" id="modalBody"></div>
            <div class="modal-footer border-0"><button class="btn btn-primary w-100" onclick="saveData()">Ø­ÙØ¸ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©</button></div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    let currentFarmId = 'farm_1';
    let currentMode = '';
    let db = JSON.parse(localStorage.getItem('smart_farm_v4')) || {
        farms: { 'farm_1': { name: "Ù…Ø²Ø±Ø¹Ø© Ø±Ù‚Ù… 1", stock: { 'ÙŠÙˆØ±ÙŠØ§': 100, 'Ø¨ÙˆØªØ§Ø³ÙŠÙˆÙ…': 50, 'Ù†ÙŠØªØ±ÙˆØ¬ÙŠÙ†': 50 }, logs: [], reminders: [], staff: {}, location: null } }
    };

    const modal = new bootstrap.Modal(document.getElementById('mainModal'));

    function createNewFarm() {
        let name = prompt("Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø²Ø±Ø¹Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©:");
        if(name) {
            let id = 'farm_' + Date.now();
            db.farms[id] = { name: name, stock: { 'ÙŠÙˆØ±ÙŠØ§': 0, 'Ø¨ÙˆØªØ§Ø³ÙŠÙˆÙ…': 0 }, logs: [], reminders: [], staff: {}, location: null };
            sync();
            initSelectors();
        }
    }

    function openAction(mode) {
        currentMode = mode;
        document.getElementById('modalTitle').innerText = mode;
        let body = document.getElementById('modalBody');
        body.innerHTML = '';

        if(mode === 'ØªØ³Ù…ÙŠØ¯') {
            body.innerHTML = `
                <label>Ø§Ø®ØªØ± Ù†ÙˆØ¹ Ø§Ù„Ø³Ù…Ø§Ø¯:</label>
                <select id="fertilizerType" class="form-select mb-2">
                    ${Object.keys(db.farms[currentFarmId].stock).map(s => `<option value="${s}">${s} (Ù…ØªØ§Ø­: ${db.farms[currentFarmId].stock[s]})</option>`).join('')}
                </select>
                <input type="number" id="fertilizerQty" class="form-control" placeholder="Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ù…Ø³ØªÙ‡Ù„ÙƒØ©">`;
        } else if(mode === 'ØªØ°ÙƒÙŠØ±') {
            body.innerHTML = `
                <input type="text" id="remTask" class="form-control mb-2" placeholder="Ù…Ø§ Ù‡Ùˆ Ø§Ù„ØªØ°ÙƒÙŠØ±ØŸ (Ù…Ø«Ù„Ø§Ù‹: Ø±ÙŠ Ø§Ù„Ø­ÙˆØ¶ Ø§Ù„Ø´Ù…Ø§Ù„ÙŠ)">
                <input type="date" id="remDate" class="form-control">`;
        } else if(mode === 'Ù…Ø®Ø²Ù†') {
            body.innerHTML = `
                <input type="text" id="itemName" class="form-control mb-2" placeholder="Ø§Ø³Ù… Ø§Ù„Ø³Ù…Ø§Ø¯/Ø§Ù„Ù…Ø§Ø¯Ø©">
                <input type="number" id="itemQty" class="form-control" placeholder="Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ù…Ø¶Ø§ÙØ© Ù„Ù„Ù…Ø®Ø²Ù†">`;
        } else if(mode === 'Ø¹Ù…Ø§Ù„Ø©') {
            body.innerHTML = `<input type="text" id="sName" class="form-control mb-2" placeholder="Ø§Ø³Ù… Ø§Ù„Ø¹Ø§Ù…Ù„">
                <select id="sStatus" class="form-select"><option value="Ø­Ø¶ÙˆØ±">Ø­Ø¶ÙˆØ± âœ…</option><option value="Ø¥Ø¬Ø§Ø²Ø©">Ø¥Ø¬Ø§Ø²Ø© ğŸ–ï¸</option></select>`;
        } else {
            body.innerHTML = `<textarea id="genDetails" class="form-control" placeholder="Ø§ÙƒØªØ¨ Ù…Ù„Ø§Ø­Ø¸Ø§ØªÙƒ Ù‡Ù†Ø§..."></textarea>`;
        }
        modal.show();
    }

    function saveData() {
        let farm = db.farms[currentFarmId];
        let date = new Date().toLocaleDateString('ar-EG');

        if(currentMode === 'ØªØ³Ù…ÙŠØ¯') {
            let type = document.getElementById('fertilizerType').value;
            let qty = parseFloat(document.getElementById('fertilizerQty').value);
            if(farm.stock[type] >= qty) {
                farm.stock[type] -= qty;
                farm.logs.push({ d: date, t: 'ØªØ³Ù…ÙŠØ¯', m: `Ø§Ø³ØªØ®Ø¯Ø§Ù… ${qty} Ù…Ù† ${type}` });
            } else { alert("Ø§Ù„ÙƒÙ…ÙŠØ© ØºÙŠØ± ÙƒØ§ÙÙŠØ© ÙÙŠ Ø§Ù„Ù…Ø®Ø²Ù†!"); return; }
        } else if(currentMode === 'ØªØ°ÙƒÙŠØ±') {
            farm.reminders.push({ d: document.getElementById('remDate').value, m: document.getElementById('remTask').value });
        } else if(currentMode === 'Ù…Ø®Ø²Ù†') {
            let name = document.getElementById('itemName').value;
            let qty = parseFloat(document.getElementById('itemQty').value);
            farm.stock[name] = (farm.stock[name] || 0) + qty;
        } else if(currentMode === 'Ø¹Ù…Ø§Ù„Ø©') {
            let name = document.getElementById('sName').value;
            let status = document.getElementById('sStatus').value;
            if(!farm.staff[name]) farm.staff[name] = { Ø­Ø¶ÙˆØ±: 0, Ø¥Ø¬Ø§Ø²Ø©: 0 };
            farm.staff[name][status]++;
        }
        
        sync();
        modal.hide();
    }

    function setFarmLocation() {
        navigator.geolocation.getCurrentPosition(pos => {
            db.farms[currentFarmId].location = { lat: pos.coords.latitude, lng: pos.coords.longitude };
            sync();
            alert("ØªÙ… Ø­ÙØ¸ Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ù…Ø²Ø±Ø¹Ø© Ø¨Ù†Ø¬Ø§Ø­!");
        });
    }

    function loadFarm() {
        currentFarmId = document.getElementById('farmSelector').value;
        updateUI();
    }

    function updateUI() {
        let farm = db.farms[currentFarmId];
        document.getElementById('farmNameHead').innerText = farm.name;
        
        // Ø¹Ø±Ø¶ Ø§Ù„ØªØ°ÙƒÙŠØ±Ø§Øª
        document.getElementById('reminderList').innerHTML = farm.reminders.map(r => 
            `<div class="alert alert-warning p-1 mb-1">ğŸ“… ${r.d} - ${r.m}</div>`
        ).join('');

        // Ø¹Ø±Ø¶ Ø§Ù„Ø¹Ù…Ø§Ù„Ø©
        let staffHTML = '';
        for(let n in farm.staff) {
            staffHTML += `<tr><td>${n}</td><td>${farm.staff[n].Ø­Ø¶ÙˆØ±}</td><td>${farm.staff[n].Ø¥Ø¬Ø§Ø²Ø©}</td></tr>`;
        }
        document.getElementById('staffList').innerHTML = staffHTML;
        
        if(farm.location) document.getElementById('locDisplay').innerText = `Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ù…Ø­ÙÙˆØ¸: ${farm.location.lat.toFixed(4)}, ${farm.location.lng.toFixed(4)}`;
    }

    function initSelectors() {
        let sel = document.getElementById('farmSelector');
        sel.innerHTML = Object.keys(db.farms).map(id => `<option value="${id}">${db.farms[id].name}</option>`).join('');
        sel.value = currentFarmId;
    }

    function sync() { localStorage.setItem('smart_farm_v4', JSON.stringify(db)); updateUI(); }

    initSelectors();
    updateUI();
</script>
</body>
</html>
