<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AGRO-ULTRA AI 2026</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        :root { --ai-primary: #0f3d0e; --ai-gold: #d4af37; --glass: rgba(255, 255, 255, 0.95); }
        body { background: #f0f2f0; font-family: 'Segoe UI', system-ui, sans-serif; padding-bottom: 100px; color: #1a1a1a; overflow-x: hidden; }

        /* واجهة الـ AI الجديدة */
        .ai-status-bar { background: linear-gradient(135deg, var(--ai-primary), #051a05); color: white; padding: 40px 20px; border-radius: 0 0 50px 50px; box-shadow: 0 10px 30px rgba(0,0,0,0.3); position: relative; }
        .ai-chip { background: rgba(255,255,255,0.1); backdrop-filter: blur(5px); border-radius: 50px; padding: 5px 15px; font-size: 0.75rem; border: 1px solid rgba(255,255,255,0.2); }
        
        /* الكروت الزجاجية */
        .glass-card { background: var(--glass); border-radius: 30px; border: 1px solid rgba(255,255,255,0.3); padding: 20px; box-shadow: 0 15px 35px rgba(0,0,0,0.05); margin-bottom: 20px; transition: 0.3s; }
        .ai-insight-box { background: #fff9e6; border-right: 5px solid var(--ai-gold); border-radius: 15px; padding: 15px; margin-top: -30px; position: relative; z-index: 10; box-shadow: 0 5px 15px rgba(0,0,0,0.05); }

        /* أزرار العمليات المودرن */
        .smart-btn { border: none; border-radius: 25px; padding: 22px 10px; background: white; box-shadow: 0 8px 20px rgba(0,0,0,0.04); display: flex; flex-direction: column; align-items: center; gap: 12px; transition: 0.3s; }
        .smart-btn i { font-size: 2rem; background: linear-gradient(135deg, #2d5a27, #1d4d1a); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .smart-btn span { font-weight: 700; font-size: 0.85rem; color: #333; }
        .smart-btn:active { transform: scale(0.9); background: #e8f5e9; }

        /* نظام الصفحات الفائق */
        .full-page { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #f8fbf8; z-index: 3000; overflow-y: auto; padding: 25px; animation: pageUp 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        .full-page.active { display: block; }
        .page-nav { display: flex; align-items: center; gap: 15px; margin-bottom: 30px; }
        .back-circle { width: 45px; height: 45px; border-radius: 50%; background: white; display: flex; align-items: center; justify-content: center; box-shadow: 0 5px 15px rgba(0,0,0,0.1); border: none; color: var(--ai-primary); font-size: 1.2rem; }

        /* شريط التنقل */
        .bottom-nav { background: rgba(255,255,255,0.9); backdrop-filter: blur(10px); position: fixed; bottom: 0; width: 100%; display: flex; justify-content: space-around; padding: 15px; border-radius: 35px 35px 0 0; box-shadow: 0 -10px 30px rgba(0,0,0,0.08); z-index: 2000; }
        .nav-item { border: none; background: none; color: #aaa; transition: 0.3s; display: flex; flex-direction: column; align-items: center; }
        .nav-item.active { color: var(--ai-primary); transform: translateY(-8px); }

        @keyframes pageUp { from { transform: translateY(100%); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
    </style>
</head>
<body>

<div id="homeView">
    <div class="ai-status-bar text-center">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <span class="ai-chip"><i class="fas fa-microchip"></i> AI Engine 2.0</span>
            <span id="liveClock" class="ai-chip"></span>
        </div>
        <h2 id="farmNameHeader" class="fw-bold mb-1">...</h2>
        <div id="weatherAI" class="small opacity-75">جاري تحليل بيانات الأقمار الصناعية...</div>
    </div>

    <div class="container px-4">
        <div class="ai-insight-box">
            <div class="d-flex align-items-center gap-2 mb-1 text-success">
                <i class="fas fa-brain"></i> <small class="fw-bold">مساعد Agro-AI:</small>
            </div>
            <p id="aiSuggestion" class="small mb-0 text-muted">بناءً على سجلاتك، المزرعة في حالة ممتازة اليوم.</p>
        </div>

        <div class="row g-3 my-4">
            <div class="col-6"><div class="glass-card text-center mb-0"> <small class="text-muted d-block mb-1">المحصول</small> <span id="kgCounter" class="h3 fw-bold text-success">0</span> <small>كجم</small> </div></div>
            <div class="col-6"><div class="glass-card text-center mb-0"> <small class="text-muted d-block mb-1">المخزن</small> <span id="stockCounter" class="h3 fw-bold text-primary">0</span> <small>صنف</small> </div></div>
        </div>

        <div class="row g-3">
            <div class="col-4"><button class="smart-btn w-100" onclick="launchOp('ري')"><i class="fas fa-faucet-drip"></i><span>ري</span></button></div>
            <div class="col-4"><button class="smart-btn w-100" onclick="launchOp('تسميد')"><i class="fas fa-flask-vial"></i><span>تسميد</span></button></div>
            <div class="col-4"><button class="smart-btn w-100" onclick="launchOp('رش')"><i class="fas fa-spray-can-sparkles"></i><span>رش</span></button></div>
            <div class="col-4"><button class="smart-btn w-100" onclick="launchOp('تقليم')"><i class="fas fa-scissors"></i><span>تقليم</span></button></div>
            <div class="col-4"><button class="smart-btn w-100" onclick="launchOp('خدمة شتوية')"><i class="fas fa-snowflake"></i><span>شتوية</span></button></div>
            <div class="col-4"><button class="smart-btn w-100" onclick="launchOp('أعطال')"><i class="fas fa-screwdriver-wrench"></i><span>أعطال</span></button></div>
            <div class="col-4"><button class="smart-btn w-100" onclick="launchOp('حصاد')"><i class="fas fa-box-open"></i><span>حصاد</span></button></div>
            <div class="col-4"><button class="smart-btn w-100" onclick="openFull('staffPage')"><i class="fas fa-users-viewfinder"></i><span>عمالة</span></button></div>
            <div class="col-4"><button class="smart-btn w-100" onclick="launchOp('أخرى')"><i class="fas fa-plus-circle"></i><span>أخرى</span></button></div>
        </div>
    </div>
</div>

<div id="opPage" class="full-page">
    <div class="page-nav">
        <button class="back-circle" onclick="goHome()"><i class="fas fa-arrow-right"></i></button>
        <h4 id="opTitle" class="fw-bold mb-0"></h4>
    </div>
    <div id="dynamicFields" class="mb-4"></div>
    <div class="glass-card mb-4 bg-light border-0">
        <label class="fw-bold d-block mb-2"><i class="fas fa-camera"></i> توثيق مصور:</label>
        <input type="file" id="opPhoto" class="form-control rounded-4 shadow-sm" accept="image/*">
    </div>
    <button class="btn btn-success w-100 py-3 rounded-pill fw-bold fs-5 shadow-lg" onclick="handleFinalSave()">إتمام وحفظ العملية</button>
</div>

<div id="staffPage" class="full-page">
    <div class="page-nav"><button class="back-circle" onclick="goHome()"><i class="fas fa-arrow-right"></i></button><h4 class="fw-bold mb-0">كشف العمالة الشهري</h4></div>
    <div class="glass-card">
        <input type="text" id="wName" class="form-control mb-3 rounded-4 p-3" placeholder="اسم العامل">
        <div class="row g-2 mb-3 text-center">
            <div class="col-4"><button class="btn btn-outline-success w-100 rounded-pill" onclick="regWorker('حضور')">حضور</button></div>
            <div class="col-4"><button class="btn btn-outline-danger w-100 rounded-pill" onclick="regWorker('غياب')">غياب</button></div>
            <div class="col-4"><button class="btn btn-outline-primary w-100 rounded-pill" onclick="regWorker('إجازة')">إجازة</button></div>
        </div>
        <div class="table-responsive">
            <table class="table table-hover text-center align-middle">
                <thead class="table-dark small"><tr><th>العامل</th><th>ح</th><th>غ</th><th>إ</th></tr></thead>
                <tbody id="workerTable" class="small"></tbody>
            </table>
        </div>
    </div>
</div>

<div id="financePage" class="full-page">
    <div class="page-nav"><button class="back-circle" onclick="goHome()"><i class="fas fa-arrow-right"></i></button><h4 class="fw-bold mb-0">الإدارة المالية</h4></div>
    <div class="glass-card">
        <input type="number" id="fAmt" class="form-control mb-2 rounded-4" placeholder="المبلغ">
        <select id="fTyp" class="form-select mb-2 rounded-4"><option value="إيراد">إيراد (+)</option><option value="مصروف">مصروف (-)</option></select>
        <input type="text" id="fDesc" class="form-control mb-3 rounded-4" placeholder="البيان">
        <button class="btn btn-primary w-100 rounded-pill py-3 fw-bold" onclick="addFin()">حفظ الحركة المالية</button>
    </div>
    <div id="financeLog"></div>
</div>

<div id="stockPage" class="full-page">
    <div class="page-nav"><button class="back-circle" onclick="goHome()"><i class="fas fa-arrow-right"></i></button><h4 class="fw-bold mb-0">المخزن</h4></div>
    <div class="glass-card mb-4">
        <input type="text" id="sItem" class="form-control mb-2 rounded-4" placeholder="الصنف">
        <input type="number" id="sQty" class="form-control mb-3 rounded-4" placeholder="الكمية">
        <button class="btn btn-success w-100 rounded-pill" onclick="addStock()">إضافة للمخزون</button>
    </div>
    <div id="stockDisplay"></div>
</div>

<div id="farmsPage" class="full-page">
    <div class="page-nav"><button class="back-circle" onclick="goHome()"><i class="fas fa-arrow-right"></i></button><h4 class="fw-bold mb-0">إدارة مزارعي</h4></div>
    <div id="farmsList" class="mb-4"></div>
    <div class="glass-card">
        <input type="text" id="newFarmInput" class="form-control mb-3 rounded-4" placeholder="اسم مزرعة جديدة">
        <button class="btn btn-success w-100 rounded-pill" onclick="createNewFarm()">إضافة المزرعة</button>
    </div>
</div>

<div id="archivePage" class="full-page">
    <div class="page-nav"><button class="back-circle" onclick="goHome()"><i class="fas fa-arrow-right"></i></button><h4 class="fw-bold mb-0">سجل النشاط</h4></div>
    <button class="btn btn-dark w-100 rounded-pill mb-4" onclick="generatePDF()"><i class="fas fa-file-pdf"></i> تحميل التقرير PDF</button>
    <div id="archiveList"></div>
</div>

<div class="bottom-nav">
    <button class="nav-item active" onclick="goHome()"><i class="fas fa-home fs-4"></i></button>
    <button class="nav-item" onclick="openFull('farmsPage')"><i class="fas fa-layer-group fs-4"></i></button>
    <button class="nav-item" onclick="openFull('stockPage')"><i class="fas fa-warehouse fs-4"></i></button>
    <button class="nav-item" onclick="openFull('financePage')"><i class="fas fa-wallet fs-4"></i></button>
    <button class="nav-item" onclick="openFull('archivePage')"><i class="fas fa-clock-rotate-left fs-4"></i></button>
</div>

<script>
    const STORAGE_KEY = 'AGRO_ULTRA_V2026_PRO';
    let db = JSON.parse(localStorage.getItem(STORAGE_KEY)) || {
        cur: 'f1', farms: { f1: { name: "مزرعة الزيتون الرئيسية", logs: [], kg: 0, stock: {}, staff: [], finance: [] } }
    };
    let currentActiveOp = '';

    function openFull(id) {
        document.querySelectorAll('.full-page').forEach(p => p.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        if(id === 'farmsPage') renderFarms();
        if(id === 'staffPage') renderStaff();
        if(id === 'financePage') renderFinance();
        if(id === 'stockPage') renderStock();
        if(id === 'archivePage') renderArchive();
    }

    function goHome() {
        document.querySelectorAll('.full-page').forEach(p => p.classList.remove('active'));
        renderHome();
    }

    function launchOp(op) {
        currentActiveOp = op; document.getElementById('opTitle').innerText = "تسجيل " + op;
        const fields = document.getElementById('dynamicFields');
        const f = db.farms[db.cur]; fields.innerHTML = '';

        if(op === 'تسميد') {
            let opts = Object.keys(f.stock).map(k => `<option value="${k}">${k} (${f.stock[k]} متوفر)</option>`).join('');
            fields.innerHTML = `<label class="fw-bold mb-2">اختر الصنف:</label><select id="inp1" class="form-select mb-3 rounded-4 p-3">${opts || '<option>المخزن فارغ</option>'}</select>
                                <input type="number" id="inp2" class="form-control rounded-4 p-3" placeholder="الكمية المستهلكة">`;
        } else if(op === 'حصاد') {
            fields.innerHTML = `<input type="number" id="inp1" class="form-control rounded-4 p-3" placeholder="الكمية كجم">`;
        } else {
            fields.innerHTML = `<textarea id="inp1" class="form-control rounded-4 p-3" rows="8" placeholder="اكتب تفاصيل العملية هنا..."></textarea>`;
        }
        openFull('opPage');
    }

    function handleFinalSave() {
        const f = db.farms[db.cur]; let msg = "";
        const v1 = document.getElementById('inp1')?.value;
        const v2 = document.getElementById('inp2')?.value;

        if (currentActiveOp === 'تسميد') {
            if (f.stock[v1] >= v2) { f.stock[v1] -= v2; msg = `استهلاك ${v2} من ${v1}`; } else { alert("عذراً المخزن لا يكفي!"); return; }
        } else if (currentActiveOp === 'حصاد') { f.kg += parseFloat(v1 || 0); msg = `حصاد ${v1} كجم`; }
        else { msg = v1; }

        if(!msg) return;
        f.logs.push({ d: new Date().toLocaleString('ar-EG'), t: currentActiveOp, m: msg });
        saveAndSync();
        goHome();
    }

    function regWorker(stat) {
        const n = document.getElementById('wName').value; if(!n) return;
        db.farms[db.cur].staff.push({ n, s: stat, d: new Date().toISOString() });
        saveAndSync(); renderStaff(); document.getElementById('wName').value = "";
    }

    function renderStaff() {
        const f = db.farms[db.cur], curM = new Date().getMonth(), curY = new Date().getFullYear();
        let rep = {};
        f.staff.forEach(e => {
            let ed = new Date(e.d);
            if(ed.getMonth() === curM && ed.getFullYear() === curY) {
                if(!rep[e.n]) rep[e.n] = { حضور:0, غياب:0, إجازة:0 };
                rep[e.n][e.s]++;
            }
        });
        document.getElementById('workerTable').innerHTML = Object.keys(rep).map(n => `<tr><td class="fw-bold">${n}</td><td class="text-success">${rep[n].حضور}</td><td class="text-danger">${rep[n].غياب}</td><td class="text-primary">${rep[n].إجازة}</td></tr>`).join('') || '<tr><td colspan="4">لا توجد بيانات لهذا الشهر</td></tr>';
    }

    function renderArchive() {
        const f = db.farms[db.cur];
        document.getElementById('archiveList').innerHTML = f.logs.map((l, i) => `
            <div class="glass-card d-flex justify-content-between align-items-center">
                <div><span class="badge bg-success mb-1">${l.t}</span><br><b>${l.m}</b><br><small class="text-muted">${l.d}</small></div>
                <button class="btn btn-sm btn-link text-primary" onclick="editArch(${i})"><i class="fas fa-edit"></i></button>
            </div>
        `).reverse().join('');
    }

    function editArch(i) { let m = prompt("تعديل النص:", db.farms[db.cur].logs[i].m); if(m){ db.farms[db.cur].logs[i].m = m; saveAndSync(); renderArchive(); } }

    function addFin() {
        const a = document.getElementById('fAmt').value, t = document.getElementById('fTyp').value, d = document.getElementById('fDesc').value;
        if(!a || !d) return;
        db.farms[db.cur].finance.push({ a: parseFloat(a), t, d, dt: new Date().toLocaleDateString('ar-EG') });
        saveAndSync(); renderFinance();
        document.getElementById('fAmt').value = ""; document.getElementById('fDesc').value = "";
    }

    function renderFinance() {
        document.getElementById('financeLog').innerHTML = db.farms[db.cur].finance.map(m => `
            <div class="glass-card mb-2 d-flex justify-content-between"><span>${m.dt}</span><b>${m.d}</b><span class="${m.t==='إيراد'?'text-success':'text-danger'}">${m.t==='إيراد'?'+':'-'}${m.a}</span></div>
        `).reverse().join('');
    }

    function renderStock() {
        document.getElementById('stockDisplay').innerHTML = Object.keys(db.farms[db.cur].stock).map(k => `
            <div class="glass-card mb-2 d-flex justify-content-between"><b>${k}</b><span class="text-success">${db.farms[db.cur].stock[k]} وحدة</span></div>
        `).join('');
    }

    function addStock() {
        let i = document.getElementById('sItem').value, q = document.getElementById('sQty').value;
        if(i && q) { db.farms[db.cur].stock[i] = (db.farms[db.cur].stock[i] || 0) + parseFloat(q); saveAndSync(); renderStock(); document.getElementById('sItem').value = ""; document.getElementById('sQty').value = ""; }
    }

    function createNewFarm() {
        let n = document.getElementById('newFarmInput').value;
        if(n) { let id = 'f'+Date.now(); db.farms[id] = { name:n, logs:[], kg:0, stock:{}, staff:[], finance:[] }; db.cur = id; saveAndSync(); goHome(); }
    }

    function renderFarms() {
        document.getElementById('farmsList').innerHTML = Object.keys(db.farms).map(id => `
            <div class="glass-card mb-2 d-flex justify-content-between align-items-center ${id===db.cur?'border-success border-2':''}" onclick="selFarm('${id}')">
                <b>${db.farms[id].name}</b> ${id===db.cur?'<i class="fas fa-check-circle text-success"></i>':''}
            </div>
        `).join('');
    }

    function selFarm(id) { db.cur = id; saveAndSync(); goHome(); }

    function renderHome() {
        const f = db.farms[db.cur];
        document.getElementById('farmNameHeader').innerText = f.name;
        document.getElementById('kgCounter').innerText = f.kg;
        document.getElementById('stockCounter').innerText = Object.keys(f.stock).length;
        document.getElementById('liveClock').innerText = new Date().toLocaleTimeString('ar-EG', {hour:'2-digit', minute:'2-digit'});
        
        // محرك الذكاء الاصطناعي Agro-AI
        if (f.logs.length > 5) document.getElementById('aiSuggestion').innerText = "تحليل AI: نلاحظ انتظاماً في التسميد، ننصح بفحص رطوبة التربة غداً.";
    }

    function saveAndSync() { localStorage.setItem(STORAGE_KEY, JSON.stringify(db)); }

    function generatePDF() {
        const f = db.farms[db.cur];
        let h = `<div dir="rtl" style="font-family:Arial; padding:30px"><h2>تقرير المزرعة: ${f.name}</h2><table border="1" style="width:100%; border-collapse:collapse; text-align:center"><tr><th>التاريخ</th><th>النوع</th><th>التفاصيل</th></tr>`;
        f.logs.forEach(l => h += `<tr><td>${l.d}</td><td>${l.t}</td><td>${l.m}</td></tr>`);
        html2pdf().from(h + "</table></div>").save('Agro_Report_2026.pdf');
    }

    navigator.geolocation.getCurrentPosition(p => {
        fetch(`https://api.open-meteo.com/v1/forecast?latitude=${p.coords.latitude}&longitude=${p.coords.longitude}&current_weather=true`)
        .then(r => r.json()).then(d => {
            const temp = d.current_weather.temperature;
            const msg = temp > 30 ? "حرارة مرتفعة | زد الري" : "طقس مثالي للعمل";
            document.getElementById('weatherAI').innerHTML = `<i class="fas fa-thermometer-half"></i> حرارة المزرعة: ${temp}°C | ${msg}`;
        });
    });

    renderHome();
</script>
</body>
</html>
