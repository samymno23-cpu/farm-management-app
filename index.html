<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Olive Farm Pro V20</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        :root { --main: #2d5a27; }
        body { 
            background: url('https://images.unsplash.com/photo-1500382017468-9049fee74a62?auto=format&fit=crop&w=1920&q=80') no-repeat center center fixed; 
            background-size: cover; font-family: 'Segoe UI', sans-serif; padding-bottom: 90px;
        }
        .overlay { background: rgba(248, 253, 248, 0.96); min-height: 100vh; }
        .top-bar { background: linear-gradient(135deg, var(--main), #1b3a18); color: white; padding: 20px; border-radius: 0 0 30px 30px; box-shadow: 0 4px 15px rgba(0,0,0,0.3); }
        .btn-action { border: none; border-radius: 18px; padding: 15px 5px; color: white; display: flex; flex-direction: column; align-items: center; gap: 8px; font-weight: bold; font-size: 0.85rem; box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        .bottom-nav { background: white; padding: 10px; position: fixed; bottom: 0; width: 100%; display: flex; justify-content: space-around; border-top: 1px solid #ddd; z-index: 1000; }
        .card-custom { background: white; border-radius: 20px; padding: 15px; margin-bottom: 15px; border: none; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
        .month-label { background: #e8f5e9; color: var(--main); padding: 5px 15px; border-radius: 10px; font-weight: bold; margin-bottom: 15px; display: inline-block; }
    </style>
</head>
<body>
<div class="overlay">
    <div class="top-bar text-center">
        <div class="d-flex justify-content-center align-items-center gap-2">
            <h4 id="farmTitle" class="fw-bold mb-0">Ù…Ø²Ø±Ø¹Ø© Ø§Ù„Ø²ÙŠØªÙˆÙ†</h4>
            <button class="btn btn-sm btn-light rounded-circle" onclick="getLoc()">ğŸ“</button>
        </div>
        <div id="weatherInfo" class="small mt-1 text-white-50">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>
    </div>

    <div class="container mt-4 px-3 text-center">
        <div class="row g-2 mb-4">
            <div class="col-6"><div class="card-custom border-bottom border-success border-4"><small>Ø§Ù„Ù…Ø­ØµÙˆÙ„</small><h4 id="kgTotal" class="mb-0 fw-bold">0</h4></div></div>
            <div class="col-6"><div class="card-custom border-bottom border-primary border-4"><small>Ø§Ù„Ù…Ø®Ø²Ù†</small><h4 id="stockCount" class="mb-0 fw-bold">0</h4></div></div>
        </div>

        <div class="row g-2 mb-3">
            <div class="col-4"><button class="btn-action w-100" style="background:#27ae60" onclick="openInput('Ø±ÙŠ')"><i class="fas fa-droplet fs-4"></i> Ø±ÙŠ</button></div>
            <div class="col-4"><button class="btn-action w-100" style="background:#f39c12" onclick="openInput('ØªØ³Ù…ÙŠØ¯')"><i class="fas fa-flask fs-4"></i> ØªØ³Ù…ÙŠØ¯</button></div>
            <div class="col-4"><button class="btn-action w-100" style="background:#3498db" onclick="openInput('Ø±Ø´')"><i class="fas fa-wind fs-4"></i> Ø±Ø´</button></div>
            <div class="col-4"><button class="btn-action w-100" style="background:#e67e22" onclick="openInput('ØªÙ‚Ù„ÙŠÙ…')"><i class="fas fa-cut fs-4"></i> ØªÙ‚Ù„ÙŠÙ…</button></div>
            <div class="col-4"><button class="btn-action w-100" style="background:#2980b9" onclick="openInput('Ø®Ø¯Ù…Ø© Ø´ØªÙˆÙŠØ©')"><i class="fas fa-snowflake fs-4"></i> Ø´ØªÙˆÙŠØ©</button></div>
            <div class="col-4"><button class="btn-action w-100" style="background:#e74c3c" onclick="openInput('Ø£Ø¹Ø·Ø§Ù„')"><i class="fas fa-tools fs-4"></i> Ø£Ø¹Ø·Ø§Ù„</button></div>
            <div class="col-4"><button class="btn-action w-100" style="background:#2c3e50" onclick="openInput('Ø­ØµØ§Ø¯')"><i class="fas fa-box-open fs-4"></i> Ø­ØµØ§Ø¯</button></div>
            <div class="col-4"><button class="btn-action w-100" style="background:#8e44ad" onclick="openStaff()"><i class="fas fa-user-clock fs-4"></i> Ø§Ù„Ø¹Ù…Ø§Ù„Ø©</button></div>
            <div class="col-4"><button class="btn-action w-100" style="background:#7f8c8d" onclick="openInput('Ø£Ø®Ø±Ù‰')"><i class="fas fa-plus fs-4"></i> Ø£Ø®Ø±Ù‰</button></div>
        </div>
        <button class="btn btn-dark w-100 py-3 rounded-4" onclick="genPDF()"><i class="fas fa-file-pdf"></i> ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø´Ø§Ù…Ù„ PDF</button>
    </div>
</div>

<div class="modal fade" id="mainModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered mx-3">
        <div class="modal-content shadow border-0" style="border-radius:25px;">
            <div class="modal-header border-0 pb-0"><h5 id="mLabel" class="fw-bold"></h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
            <div class="modal-body" id="mBody"></div>
            <div class="px-3 pb-3">
                <input type="file" id="mFile" class="form-control mb-3" accept="image/*">
                <button class="btn btn-success w-100 py-3 fw-bold rounded-4" onclick="saveData()">Ø­ÙØ¸</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="staffModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-fullscreen-sm-down">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white"><h5 class="fw-bold mb-0">ÙƒØ´Ù Ø§Ù„Ø¹Ù…Ø§Ù„Ø© Ø§Ù„Ø´Ù‡Ø±ÙŠ</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div>
            <div class="modal-body">
                <div class="month-label" id="curMonthName"></div>
                <div class="card p-3 mb-3 border-0 bg-light shadow-sm">
                    <div class="input-group">
                        <input type="text" id="wName" class="form-control" placeholder="Ø§Ø³Ù… Ø§Ù„Ø¹Ø§Ù…Ù„">
                        <select id="wStat" class="form-select w-25"><option value="Ø­Ø¶ÙˆØ±">Ø­Ø¶ÙˆØ±</option><option value="ØºÙŠØ§Ø¨">ØºÙŠØ§Ø¨</option><option value="Ø¥Ø¬Ø§Ø²Ø©">Ø¥Ø¬Ø§Ø²Ø©</option></select>
                        <button class="btn btn-success" onclick="addStaff()">ØªØ³Ø¬ÙŠÙ„</button>
                    </div>
                </div>
                <div class="table-responsive">
                    <table class="table table-bordered text-center small"><thead class="table-light"><tr><th>Ø§Ù„Ø¹Ø§Ù…Ù„</th><th>Ø­Ø¶ÙˆØ±</th><th>Ø¥Ø¬Ø§Ø²Ø©</th><th>ØºÙŠØ§Ø¨</th></tr></thead><tbody id="stTable"></tbody></table>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="bottom-nav">
    <button class="btn text-success" onclick="location.reload()"><i class="fas fa-home fs-4"></i></button>
    <button class="btn text-secondary" onclick="openFarms()"><i class="fas fa-layer-group fs-4"></i></button>
    <button class="btn text-secondary" onclick="openInput('Ù…Ø®Ø²Ù†')"><i class="fas fa-warehouse fs-4"></i></button>
    <button class="btn text-secondary" onclick="openArchive()"><i class="fas fa-history fs-4"></i></button>
    <button class="btn text-secondary" onclick="openInput('ØªØ°ÙƒÙŠØ±')"><i class="fas fa-bell fs-4"></i></button>
</div>

<div id="pdfArea" style="display:none; padding: 30px; direction: rtl; font-family: 'Arial';">
    <h2 style="text-align:center;">Ø³Ø¬Ù„ Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ù…Ø²Ø±Ø¹Ø©</h2>
    <div id="pdfBody"></div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    const KEY = 'olive_v20_final';
    let db = JSON.parse(localStorage.getItem(KEY)) || { cur:'f1', farms:{ f1:{ name:"Ø§Ù„Ù…Ø²Ø±Ø¹Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©", logs:[], kg:0, stock:{}, staff:[] } } };
    const mModal = new bootstrap.Modal(document.getElementById('mainModal'));
    const sModal = new bootstrap.Modal(document.getElementById('staffModal'));
    let curT = '';

    function openInput(t) {
        curT = t; document.getElementById('mLabel').innerText = "ØªØ³Ø¬ÙŠÙ„ " + t;
        const b = document.getElementById('mBody'); b.innerHTML = '';
        const f = db.farms[db.cur];
        if(t === 'ØªØ³Ù…ÙŠØ¯') {
            let o = Object.keys(f.stock).map(k => `<option value="${k}">${k} (${f.stock[k]})</option>`).join('');
            b.innerHTML = `<select id="i1" class="form-select mb-2">${o || '<option>Ø§Ù„Ù…Ø®Ø²Ù† ÙØ§Ø±Øº</option>'}</select><input type="number" id="i2" class="form-control" placeholder="Ø§Ù„ÙƒÙ…ÙŠØ©">`;
        } else if(t === 'Ù…Ø®Ø²Ù†') {
            b.innerHTML = `<input type="text" id="i1" class="form-control mb-2" placeholder="Ø§Ù„ØµÙ†Ù"><input type="number" id="i2" class="form-control" placeholder="Ø§Ù„ÙƒÙ…ÙŠØ©">`;
        } else if(t === 'Ø­ØµØ§Ø¯') {
            b.innerHTML = `<input type="number" id="i1" class="form-control" placeholder="ÙƒØ¬Ù…">`;
        } else {
            b.innerHTML = `<textarea id="i1" class="form-control" rows="3" placeholder="Ø§Ù„ØªÙØ§ØµÙŠÙ„..."></textarea>`;
        }
        mModal.show();
    }

    function saveData() {
        const f = db.farms[db.cur]; let msg = "";
        const val1 = document.getElementById('i1')?.value;
        const val2 = document.getElementById('i2')?.value;

        if(curT === 'ØªØ³Ù…ÙŠØ¯') {
            if(f.stock[val1] >= val2) { f.stock[val1] -= val2; msg = `ØªØ³Ù…ÙŠØ¯: ${val1} (${val2})`; } else { alert("Ù„Ø§ ÙŠÙƒÙÙŠ!"); return; }
        } else if(curT === 'Ù…Ø®Ø²Ù†') {
            f.stock[val1] = (f.stock[val1] || 0) + parseFloat(val2 || 0); msg = `Ø¥Ø¶Ø§ÙØ© Ù…Ø®Ø²Ù†: ${val1} (+${val2})`;
        } else if(curT === 'Ø­ØµØ§Ø¯') {
            f.kg += parseFloat(val1 || 0); msg = `Ø­ØµØ§Ø¯ ${val1} ÙƒØ¬Ù…`;
        } else { msg = val1; }

        f.logs.push({ d: new Date().toLocaleString('ar-EG'), t: curT, m: msg });
        save(); mModal.hide(); render();
    }

    function openStaff() {
        const d = new Date();
        document.getElementById('curMonthName').innerText = "Ø´Ù‡Ø±: " + d.toLocaleString('ar-EG', {month:'long', year:'numeric'});
        renderStaff(); sModal.show();
    }

    function addStaff() {
        const n = document.getElementById('wName').value, s = document.getElementById('wStat').value, f = db.farms[db.cur];
        if(!n) return;
        f.staff.push({ n: n, s: s, date: new Date().toISOString() });
        save(); renderStaff(); document.getElementById('wName').value = "";
    }

    function renderStaff() {
        const f = db.farms[db.cur], curM = new Date().getMonth(), curY = new Date().getFullYear();
        let rep = {};
        f.staff.forEach(e => {
            let ed = new Date(e.date);
            if(ed.getMonth() === curM && ed.getFullYear() === curY) {
                if(!rep[e.n]) rep[e.n] = { Ø­Ø¶ÙˆØ±:0, Ø¥Ø¬Ø§Ø²Ø©:0, ØºÙŠØ§Ø¨:0 };
                rep[e.n][e.s]++;
            }
        });
        let h = "";
        for(let n in rep) h += `<tr><td class="fw-bold">${n}</td><td class="text-success">${rep[n].Ø­Ø¶ÙˆØ±}</td><td>${rep[n].Ø¥Ø¬Ø§Ø²Ø©}</td><td class="text-danger">${rep[n].ØºÙŠØ§Ø¨}</td></tr>`;
        document.getElementById('stTable').innerHTML = h || '<tr><td colspan="4">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª</td></tr>';
    }

    function genPDF() {
        const f = db.farms[db.cur];
        let h = `<h3 style="text-align:center">Ù…Ø²Ø±Ø¹Ø©: ${f.name}</h3><table border="1" style="width:100%; border-collapse:collapse; text-align:right"><tr><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø§Ù„Ù†ÙˆØ¹</th><th>Ø§Ù„ØªÙØ§ØµÙŠÙ„</th></tr>`;
        f.logs.forEach(l => h += `<tr><td>${l.d}</td><td>${l.t}</td><td>${l.m}</td></tr>`);
        document.getElementById('pdfBody').innerHTML = h + `</table>`;
        const opt = { margin: 0.5, filename: 'Report.pdf', html2canvas: { scale: 2 }, jsPDF: { unit: 'in', format: 'letter', orientation: 'portrait' } };
        html2pdf().set(opt).from(document.getElementById('pdfArea')).show().save();
    }

    function render() {
        const f = db.farms[db.cur]; document.getElementById('farmTitle').innerText = f.name;
        document.getElementById('kgTotal').innerText = f.kg;
        document.getElementById('stockCount').innerText = Object.keys(f.stock).length;
    }

    function save() { localStorage.setItem(KEY, JSON.stringify(db)); }
    function getLoc() { navigator.geolocation.getCurrentPosition(p => fetch(`https://api.open-meteo.com/v1/forecast?latitude=${p.coords.latitude}&longitude=${p.coords.longitude}&current_weather=true`).then(r => r.json()).then(d => document.getElementById('weatherInfo').innerText = `Ø§Ù„Ø­Ø±Ø§Ø±Ø©: ${d.current_weather.temperature}Â°C`)); }
    
    render(); getLoc();
</script>
</body>
</html>
