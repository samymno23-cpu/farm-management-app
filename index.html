<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Olive Farm Pro V21</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        :root { --main: #2d5a27; --bg: #f4f7f4; }
        body { background-color: var(--bg); font-family: 'Segoe UI', sans-serif; overflow-x: hidden; margin: 0; }
        .page { display: none; min-height: 100vh; padding: 20px; background: white; position: fixed; top: 0; left: 0; width: 100%; z-index: 2000; overflow-y: auto; }
        .page.active { display: block; }
        .home-overlay { background: rgba(248, 253, 248, 0.96); min-height: 100vh; }
        .top-bar { background: linear-gradient(135deg, var(--main), #1b3a18); color: white; padding: 20px; border-radius: 0 0 30px 30px; }
        .btn-action { border: none; border-radius: 20px; padding: 20px 5px; color: white; display: flex; flex-direction: column; align-items: center; gap: 10px; font-weight: bold; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .bottom-nav { background: white; padding: 12px; position: fixed; bottom: 0; width: 100%; display: flex; justify-content: space-around; border-top: 1px solid #ddd; z-index: 1000; }
        .card-custom { border-radius: 15px; border: none; box-shadow: 0 4px 12px rgba(0,0,0,0.05); padding: 15px; margin-bottom: 15px; background: white; }
        .header-page { display: flex; align-items: center; gap: 15px; margin-bottom: 20px; border-bottom: 2px solid var(--main); padding-bottom: 10px; }
        .btn-save { background: var(--main); color: white; border-radius: 15px; padding: 12px; font-weight: bold; border: none; width: 100%; }
    </style>
</head>
<body>

<div id="homePage" class="home-overlay pb-5">
    <div class="top-bar text-center">
        <h4 id="farmTitle" class="fw-bold mb-0">Ù…Ø²Ø±Ø¹Ø© Ø§Ù„Ø²ÙŠØªÙˆÙ†</h4>
        <small id="weatherInfo">Ø¬Ø§Ø±ÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø·Ù‚Ø³ ÙˆØ§Ù„Ù…ÙˆÙ‚Ø¹...</small>
    </div>

    <div class="container mt-4 px-3 text-center">
        <div class="row g-2 mb-4">
            <div class="col-6"><div class="card-custom border-bottom border-success border-4"><small>Ø§Ù„Ù…Ø­ØµÙˆÙ„</small><h4 id="kgTotal" class="mb-0 fw-bold">0</h4></div></div>
            <div class="col-6"><div class="card-custom border-bottom border-primary border-4"><small>Ø§Ù„Ù…Ø®Ø²Ù†</small><h4 id="stockCount" class="mb-0 fw-bold">0</h4></div></div>
        </div>

        <div class="row g-3">
            <div class="col-4"><button class="btn-action w-100" style="background:#27ae60" onclick="showPage('opPage', 'Ø±ÙŠ')"><i class="fas fa-droplet fs-3"></i> Ø±ÙŠ</button></div>
            <div class="col-4"><button class="btn-action w-100" style="background:#f39c12" onclick="showPage('opPage', 'ØªØ³Ù…ÙŠØ¯')"><i class="fas fa-flask fs-3"></i> ØªØ³Ù…ÙŠØ¯</button></div>
            <div class="col-4"><button class="btn-action w-100" style="background:#3498db" onclick="showPage('opPage', 'Ø±Ø´')"><i class="fas fa-wind fs-3"></i> Ø±Ø´</button></div>
            <div class="col-4"><button class="btn-action w-100" style="background:#e67e22" onclick="showPage('opPage', 'ØªÙ‚Ù„ÙŠÙ…')"><i class="fas fa-cut fs-3"></i> ØªÙ‚Ù„ÙŠÙ…</button></div>
            <div class="col-4"><button class="btn-action w-100" style="background:#2980b9" onclick="showPage('opPage', 'Ø®Ø¯Ù…Ø© Ø´ØªÙˆÙŠØ©')"><i class="fas fa-snowflake fs-3"></i> Ø´ØªÙˆÙŠØ©</button></div>
            <div class="col-4"><button class="btn-action w-100" style="background:#e74c3c" onclick="showPage('opPage', 'Ø£Ø¹Ø·Ø§Ù„')"><i class="fas fa-tools fs-3"></i> Ø£Ø¹Ø·Ø§Ù„</button></div>
            <div class="col-4"><button class="btn-action w-100" style="background:#2c3e50" onclick="showPage('opPage', 'Ø­ØµØ§Ø¯')"><i class="fas fa-box-open fs-3"></i> Ø­ØµØ§Ø¯</button></div>
            <div class="col-4"><button class="btn-action w-100" style="background:#8e44ad" onclick="showPage('staffPage')"><i class="fas fa-user-clock fs-3"></i> Ø§Ù„Ø¹Ù…Ø§Ù„Ø©</button></div>
            <div class="col-4"><button class="btn-action w-100" style="background:#7f8c8d" onclick="showPage('opPage', 'Ø£Ø®Ø±Ù‰')"><i class="fas fa-plus fs-3"></i> Ø£Ø®Ø±Ù‰</button></div>
        </div>
        <button class="btn btn-dark w-100 py-3 mt-4 rounded-4" onclick="generatePDF()"><i class="fas fa-file-pdf"></i> ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªÙ‚Ø±ÙŠØ± PDF</button>
    </div>
</div>

<div id="opPage" class="page">
    <div class="header-page">
        <button class="btn btn-outline-dark border-0" onclick="hidePage()"><i class="fas fa-arrow-right"></i></button>
        <h4 id="opTitle" class="mb-0 fw-bold">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©</h4>
    </div>
    <div id="opFields"></div>
    <label class="fw-bold mt-3 mb-2">ğŸ“¸ Ø¥Ø±ÙØ§Ù‚ ØµÙˆØ±Ø©:</label>
    <input type="file" id="opFile" class="form-control mb-4" accept="image/*">
    <button class="btn-save" onclick="saveOperation()">Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØ§Ù„Ø¹ÙˆØ¯Ø©</button>
</div>

<div id="staffPage" class="page">
    <div class="header-page">
        <button class="btn btn-outline-dark border-0" onclick="hidePage()"><i class="fas fa-arrow-right"></i></button>
        <h4 class="mb-0 fw-bold">ÙƒØ´Ù Ø§Ù„Ø¹Ù…Ø§Ù„Ø© Ø§Ù„Ø´Ù‡Ø±ÙŠ</h4>
    </div>
    <div class="card-custom bg-light">
        <input type="text" id="wName" class="form-control mb-2" placeholder="Ø§Ø³Ù… Ø§Ù„Ø¹Ø§Ù…Ù„">
        <select id="wStat" class="form-select mb-3"><option value="Ø­Ø¶ÙˆØ±">Ø­Ø¶ÙˆØ±</option><option value="ØºÙŠØ§Ø¨">ØºÙŠØ§Ø¨</option><option value="Ø¥Ø¬Ø§Ø²Ø©">Ø¥Ø¬Ø§Ø²Ø©</option></select>
        <button class="btn btn-success w-100" onclick="addStaffRecord()">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ÙŠÙˆÙ…ÙŠØ©</button>
    </div>
    <div class="table-responsive mt-3">
        <table class="table table-bordered text-center"><thead class="table-dark"><tr><th>Ø§Ù„Ø¹Ø§Ù…Ù„</th><th>Ø­</th><th>Ø¥</th><th>Øº</th></tr></thead><tbody id="stTable"></tbody></table>
    </div>
</div>

<div id="farmsPage" class="page">
    <div class="header-page">
        <button class="btn btn-outline-dark border-0" onclick="hidePage()"><i class="fas fa-arrow-right"></i></button>
        <h4 class="mb-0 fw-bold">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø²Ø§Ø±Ø¹</h4>
    </div>
    <div id="farmsList" class="list-group mb-4"></div>
    <div class="card-custom bg-light">
        <input type="text" id="newFarmInput" class="form-control mb-2" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø²Ø±Ø¹Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©">
        <button class="btn btn-primary w-100" onclick="createNewFarm()">Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø²Ø±Ø¹Ø©</button>
    </div>
</div>

<div id="archivePage" class="page">
    <div class="header-page">
        <button class="btn btn-outline-dark border-0" onclick="hidePage()"><i class="fas fa-arrow-right"></i></button>
        <h4 class="mb-0 fw-bold">Ø³Ø¬Ù„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª (ØªØ¹Ø¯ÙŠÙ„)</h4>
    </div>
    <div id="archiveContent"></div>
</div>

<div id="stockPage" class="page">
    <div class="header-page">
        <button class="btn btn-outline-dark border-0" onclick="hidePage()"><i class="fas fa-arrow-right"></i></button>
        <h4 class="mb-0 fw-bold">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø®Ø²Ù†</h4>
    </div>
    <div class="card-custom bg-light">
        <input type="text" id="sItem" class="form-control mb-2" placeholder="Ø§Ø³Ù… Ø§Ù„ØµÙ†Ù">
        <input type="number" id="sQty" class="form-control mb-3" placeholder="Ø§Ù„ÙƒÙ…ÙŠØ©">
        <button class="btn btn-primary w-100" onclick="addToStock()">Ø¥Ø¶Ø§ÙØ© Ù„Ù„Ù…Ø®Ø²Ù†</button>
    </div>
    <div id="stockList" class="mt-3"></div>
</div>

<div class="bottom-nav">
    <button class="btn text-success" onclick="hidePage()"><i class="fas fa-home fs-4"></i></button>
    <button class="btn text-secondary" onclick="showPage('farmsPage')"><i class="fas fa-layer-group fs-4"></i></button>
    <button class="btn text-secondary" onclick="showPage('stockPage')"><i class="fas fa-warehouse fs-4"></i></button>
    <button class="btn text-secondary" onclick="showPage('archivePage')"><i class="fas fa-history fs-4"></i></button>
</div>

<script>
    const STORAGE_KEY = 'olive_pro_v21_final';
    let db = JSON.parse(localStorage.getItem(STORAGE_KEY)) || { cur: 'f1', farms: { f1: { name: "Ø§Ù„Ù…Ø²Ø±Ø¹Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©", logs: [], kg: 0, stock: {}, staff: [] } } };
    let currentOp = ''; let editIdx = null;

    function showPage(pageId, op = '') {
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        document.getElementById(pageId).classList.add('active');
        if(op) {
            currentOp = op; document.getElementById('opTitle').innerText = "ØªØ³Ø¬ÙŠÙ„: " + op;
            renderOpFields(op);
        }
        if(pageId === 'farmsPage') renderFarms();
        if(pageId === 'staffPage') renderStaff();
        if(pageId === 'archivePage') renderArchive();
        if(pageId === 'stockPage') renderStock();
    }

    function hidePage() { document.querySelectorAll('.page').forEach(p => p.classList.remove('active')); renderHome(); }

    function renderOpFields(op) {
        const div = document.getElementById('opFields'); div.innerHTML = '';
        const f = db.farms[db.cur];
        if(op === 'ØªØ³Ù…ÙŠØ¯') {
            let opts = Object.keys(f.stock).map(k => `<option value="${k}">${k} (${f.stock[k]})</option>`).join('');
            div.innerHTML = `<label>Ø§Ø®ØªØ± Ø§Ù„Ø³Ù…Ø§Ø¯:</label><select id="inp1" class="form-select mb-2">${opts}</select><input type="number" id="inp2" class="form-control" placeholder="Ø§Ù„ÙƒÙ…ÙŠØ©">`;
        } else if(op === 'Ø­ØµØ§Ø¯') {
            div.innerHTML = `<input type="number" id="inp1" class="form-control" placeholder="Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ù…Ù‚Ø·ÙˆÙØ© Ø¨Ø§Ù„ÙƒØ¬Ù…">`;
        } else {
            div.innerHTML = `<textarea id="inp1" class="form-control" rows="5" placeholder="Ø§ÙƒØªØ¨ ÙƒÙ„ Ø§Ù„ØªÙØ§ØµÙŠÙ„ Ù‡Ù†Ø§..."></textarea>`;
        }
    }

    function saveOperation() {
        const f = db.farms[db.cur]; let msg = "";
        const v1 = document.getElementById('inp1')?.value;
        const v2 = document.getElementById('inp2')?.value;

        if(currentOp === 'ØªØ³Ù…ÙŠØ¯') {
            if(f.stock[v1] >= v2) { f.stock[v1] -= v2; msg = `ØªØ³Ù…ÙŠØ¯: ${v1} (${v2})`; } else { alert("Ø§Ù„Ù…Ø®Ø²Ù† Ù„Ø§ ÙŠÙƒÙÙŠ!"); return; }
        } else if(currentOp === 'Ø­ØµØ§Ø¯') { f.kg += parseFloat(v1 || 0); msg = `Ø­ØµØ§Ø¯ ${v1} ÙƒØ¬Ù…`; }
        else { msg = v1; }

        f.logs.push({ d: new Date().toLocaleString('ar-EG'), t: currentOp, m: msg });
        save(); hidePage();
    }

    function renderArchive() {
        const f = db.farms[db.cur];
        document.getElementById('archiveContent').innerHTML = f.logs.map((l, idx) => `
            <div class="card-custom d-flex justify-content-between align-items-center">
                <div><b>${l.t}</b>: ${l.m}<br><small class="text-muted">${l.d}</small></div>
                <button class="btn btn-sm btn-outline-primary" onclick="editLog(${idx})">ØªØ¹Ø¯ÙŠÙ„</button>
            </div>
        `).reverse().join('');
    }

    function editLog(idx) {
        let f = db.farms[db.cur];
        let newMsg = prompt("ØªØ¹Ø¯ÙŠÙ„ Ù†Øµ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©:", f.logs[idx].m);
        if(newMsg) { f.logs[idx].m = newMsg; save(); renderArchive(); }
    }

    function renderStaff() {
        const f = db.farms[db.cur], m = new Date().getMonth(), y = new Date().getFullYear();
        let rep = {};
        f.staff.forEach(e => {
            let ed = new Date(e.dt);
            if(ed.getMonth() === m && ed.getFullYear() === y) {
                if(!rep[e.n]) rep[e.n] = { Ø­Ø¶ÙˆØ±:0, Ø¥Ø¬Ø§Ø²Ø©:0, ØºÙŠØ§Ø¨:0 };
                rep[e.n][e.s]++;
            }
        });
        document.getElementById('stTable').innerHTML = Object.keys(rep).map(n => `<tr><td>${n}</td><td class="text-success">${rep[n].Ø­Ø¶ÙˆØ±}</td><td>${rep[n].Ø¥Ø¬Ø§Ø²Ø©}</td><td class="text-danger">${rep[n].ØºÙŠØ§Ø¨}</td></tr>`).join('');
    }

    function addStaffRecord() {
        const n = document.getElementById('wName').value, s = document.getElementById('wStat').value;
        if(n) { db.farms[db.cur].staff.push({ n:n, s:s, dt: new Date().toISOString() }); save(); renderStaff(); document.getElementById('wName').value=''; }
    }

    function renderFarms() {
        document.getElementById('farmsList').innerHTML = Object.keys(db.farms).map(id => `
            <button class="list-group-item list-group-item-action d-flex justify-content-between ${id==db.cur?'active':''}" onclick="selectFarm('${id}')">
                ${db.farms[id].name} <span>${id==db.cur?'(Ø§Ù„Ø­Ø§Ù„ÙŠØ©)':''}</span>
            </button>
        `).join('');
    }

    function createNewFarm() {
        let n = document.getElementById('newFarmInput').value;
        if(n) { let id = 'f'+Date.now(); db.farms[id] = { name:n, logs:[], kg:0, stock:{}, staff:[] }; db.cur = id; save(); renderFarms(); document.getElementById('newFarmInput').value=''; }
    }

    function selectFarm(id) { db.cur = id; save(); renderFarms(); }

    function renderStock() {
        const f = db.farms[db.cur];
        document.getElementById('stockList').innerHTML = Object.keys(f.stock).map(k => `
            <div class="card-custom d-flex justify-content-between"><span>${k}</span><b>${f.stock[k]} ÙˆØ­Ø¯Ø©</b></div>
        `).join('');
    }

    function addToStock() {
        const n = document.getElementById('sItem').value, q = document.getElementById('sQty').value;
        if(n) { db.farms[db.cur].stock[n] = (db.farms[db.cur].stock[n] || 0) + parseFloat(q); save(); renderStock(); }
    }

    function save() { localStorage.setItem(STORAGE_KEY, JSON.stringify(db)); }
    function renderHome() {
        const f = db.farms[db.cur]; document.getElementById('farmTitle').innerText = f.name;
        document.getElementById('kgTotal').innerText = f.kg; document.getElementById('stockCount').innerText = Object.keys(f.stock).length;
    }

    function generatePDF() {
        const f = db.farms[db.cur];
        let h = `<h2 style="text-align:center">ØªÙ‚Ø±ÙŠØ± Ù…Ø²Ø±Ø¹Ø©: ${f.name}</h2><table border="1" style="width:100%; border-collapse:collapse; text-align:right"><tr><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø§Ù„Ù†ÙˆØ¹</th><th>Ø§Ù„ØªÙØ§ØµÙŠÙ„</th></tr>`;
        f.logs.forEach(l => h += `<tr><td>${l.d}</td><td>${l.t}</td><td>${l.m}</td></tr>`);
        let opt = { margin: 0.5, filename: 'Report.pdf', html2canvas: { scale: 2 }, jsPDF: { unit: 'in', format: 'letter', orientation: 'portrait' } };
        html2pdf().set(opt).from(h + "</table>").save();
    }

    navigator.geolocation.getCurrentPosition(p => {
        fetch(`https://api.open-meteo.com/v1/forecast?latitude=${p.coords.latitude}&longitude=${p.coords.longitude}&current_weather=true`)
        .then(r => r.json()).then(d => document.getElementById('weatherInfo').innerText = `Ø§Ù„Ø­Ø±Ø§Ø±Ø© Ø§Ù„Ø¢Ù†: ${d.current_weather.temperature}Â°C`);
    });

    renderHome();
</script>
</body>
</html>
