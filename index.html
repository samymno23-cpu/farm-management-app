<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù…Ù†Ø¸ÙˆÙ…Ø© Ø§Ù„Ù…Ø²Ø§Ø±Ø¹ Ø§Ù„Ø°ÙƒÙŠØ© V5</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        :root { --primary: #4b5d16; --accent: #d4a017; }
        body { background-color: #f4f7f6; font-family: 'Segoe UI', sans-serif; padding-bottom: 30px; }
        .app-header { background: linear-gradient(135deg, var(--primary), #1a2408); color: white; padding: 20px; border-radius: 0 0 30px 30px; box-shadow: 0 4px 15px rgba(0,0,0,0.2); }
        .card-pro { border-radius: 20px; border: none; box-shadow: 0 6px 12px rgba(0,0,0,0.05); margin-bottom: 15px; background: white; }
        .weather-card { background: #fff; border-left: 8px solid #3498db; padding: 15px; border-radius: 15px; margin-top: -30px; z-index: 10; position: relative; }
        .btn-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; }
        .btn-tool { border-radius: 15px; padding: 15px 5px; font-size: 0.85rem; font-weight: bold; border: none; color: white; transition: 0.3s; }
        .img-preview { width: 100%; max-height: 150px; object-fit: cover; border-radius: 10px; margin-top: 10px; display: none; }
        .log-img { width: 60px; height: 60px; border-radius: 8px; object-fit: cover; cursor: pointer; }
    </style>
</head>
<body>

<div class="app-header text-center">
    <h3 id="farmNameDisplay">Ø§Ù„Ù…Ø²Ø±Ø¹Ø© Ø§Ù„Ø°ÙƒÙŠØ©</h3>
    <div class="d-flex justify-content-center gap-2 mt-2">
        <select id="farmSelector" class="form-select form-select-sm w-50" onchange="changeFarm()"></select>
        <button class="btn btn-light btn-sm" onclick="addFarm()">+ Ù…Ø²Ø±Ø¹Ø©</button>
    </div>
</div>

<div class="container mt-2">
    <div class="weather-card shadow-sm mb-3">
        <div class="row align-items-center">
            <div class="col-8">
                <h6 class="mb-0 fw-bold">Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ù‚Ø³ Ø§Ù„Ø¢Ù† ÙÙŠ Ù…ÙˆÙ‚Ø¹Ùƒ:</h6>
                <div id="weatherData"><small>Ø¬Ø§Ø±ÙŠ Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ù‚Ø³...</small></div>
            </div>
            <div class="col-4 text-center">
                <button class="btn btn-sm btn-outline-primary" onclick="getWeather()">ğŸ”„ ØªØ­Ø¯ÙŠØ«</button>
            </div>
        </div>
    </div>

    <div class="card-pro p-3">
        <div class="btn-grid">
            <button class="btn-tool" style="background: #27ae60;" onclick="openOp('Ø±ÙŠ')">ğŸ’§<br>Ø±ÙŠ</button>
            <button class="btn-tool" style="background: #f39c12;" onclick="openOp('ØªØ³Ù…ÙŠØ¯')">ğŸ§ª<br>ØªØ³Ù…ÙŠØ¯</button>
            <button class="btn-tool" style="background: #9b59b6;" onclick="openOp('Ø±Ø´')">ğŸ’¨<br>Ø±Ø´</button>
            <button class="btn-tool" style="background: #e74c3c;" onclick="openOp('Ø£Ø¹Ø·Ø§Ù„')">ğŸ› ï¸<br>Ø£Ø¹Ø·Ø§Ù„</button>
            <button class="btn-tool" style="background: #2c3e50;" onclick="openOp('Ø­ØµØ§Ø¯')">ğŸ“¦<br>Ø­ØµØ§Ø¯</button>
            <button class="btn-tool" style="background: #34495e;" onclick="generateReport()">ğŸ“‘<br>ØªÙ‚Ø±ÙŠØ±</button>
        </div>
    </div>

    <div class="row g-2">
        <div class="col-6"><button class="btn btn-white card-pro w-100 p-3" onclick="openOp('ØªØ°ÙƒÙŠØ±')">â° ØªØ°ÙƒÙŠØ± Ù…ÙˆØ¹Ø¯</button></div>
        <div class="col-6"><button class="btn btn-white card-pro w-100 p-3" onclick="openOp('Ù…Ø®Ø²Ù†')">ğŸ  Ø§Ù„Ù…Ø®Ø§Ø²Ù†</button></div>
    </div>

    <div class="card-pro p-3">
        <h6 class="fw-bold mb-3 border-bottom pb-2">ğŸ“œ Ø³Ø¬Ù„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ù…ØµÙˆØ±:</h6>
        <div id="logContent" class="small"></div>
    </div>
</div>

<div class="modal fade" id="opModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content" style="border-radius:20px;">
            <div class="modal-header border-0"><h5 id="modalTitle"></h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
            <div class="modal-body" id="modalBody"></div>
            <div class="p-3 border-top">
                <label class="form-label small fw-bold">ğŸ“¸ Ø¥Ø¶Ø§ÙØ© ØµÙˆØ±Ø© Ù„Ù„Ø¹Ù…Ù„ÙŠØ©:</label>
                <input type="file" id="imgInput" class="form-control form-control-sm" accept="image/*" onchange="previewImg(this)">
                <img id="pImg" class="img-preview">
                <button class="btn btn-primary w-100 mt-3" onclick="saveOp()">Ø­ÙØ¸ ÙˆØ¥Ø¶Ø§ÙØ© Ù„Ù„Ø³Ø¬Ù„</button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    let db = JSON.parse(localStorage.getItem('farm_v5_db')) || { 
        farms: { 'f1': { name: "Ù…Ø²Ø±Ø¹Ø© Ø§Ù„ÙˆØ§Ø¯ÙŠ", logs: [], stock: {}, reminders: [] } } 
    };
    let curFarm = 'f1'; let curMode = '';
    const modal = new bootstrap.Modal(document.getElementById('opModal'));

    function getWeather() {
        navigator.geolocation.getCurrentPosition(pos => {
            const lat = pos.coords.latitude; const lon = pos.coords.longitude;
            // Ø§Ø³ØªØ®Ø¯Ø§Ù… API Ù…Ø¬Ø§Ù†ÙŠ Ù„Ù„Ø·Ù‚Ø³
            fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current_weather=true`)
            .then(r => r.json()).then(data => {
                const w = data.current_weather;
                document.getElementById('weatherData').innerHTML = `<span class="h4">${w.temperature}Â°C</span> | Ø±ÙŠØ§Ø­: ${w.windspeed} ÙƒÙ…/Ø³`;
            });
        });
    }

    function openOp(mode) {
        curMode = mode; document.getElementById('modalTitle').innerText = mode;
        const body = document.getElementById('modalBody'); body.innerHTML = '';
        document.getElementById('pImg').style.display = 'none'; document.getElementById('imgInput').value = '';

        if(mode === 'ØªØ³Ù…ÙŠØ¯') {
            body.innerHTML = `<select id="fType" class="form-select mb-2"><option>ÙŠÙˆØ±ÙŠØ§</option><option>Ù†ØªØ±Ø§Øª</option><option>Ø¨ÙˆØªØ§Ø³ÙŠÙˆÙ…</option></select>
                             <input type="number" id="fQty" class="form-control" placeholder="Ø§Ù„ÙƒÙ…ÙŠØ©">`;
        } else if(mode === 'ØªØ°ÙƒÙŠØ±') {
            body.innerHTML = `<input type="text" id="tName" class="form-control mb-2" placeholder="Ø§Ù„Ù…Ù‡Ù…Ø©"><input type="date" id="tDate" class="form-control">`;
        } else {
            body.innerHTML = `<textarea id="tDetails" class="form-control" placeholder="ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©..."></textarea>`;
        }
        modal.show();
    }

    function previewImg(input) {
        const p = document.getElementById('pImg');
        if (input.files && input.files[0]) {
            const reader = new FileReader();
            reader.onload = e => { p.src = e.target.result; p.style.display = 'block'; };
            reader.readAsDataURL(input.files[0]);
        }
    }

    function saveOp() {
        const farm = db.farms[curFarm];
        const img = document.getElementById('pImg').src;
        const log = { d: new Date().toLocaleString('ar-EG'), t: curMode, m: '', img: img.startsWith('data') ? img : null };

        if(curMode === 'ØªØ³Ù…ÙŠØ¯') log.m = `ØªØ³Ù…ÙŠØ¯ Ø¨Ù€ ${document.getElementById('fType').value} - ${document.getElementById('fQty').value} ÙƒØ¬Ù…`;
        else if(curMode === 'ØªØ°ÙƒÙŠØ±') farm.reminders.push({ d: document.getElementById('tDate').value, m: document.getElementById('tName').value });
        else log.m = document.getElementById('tDetails').value;

        if(log.m || log.img) farm.logs.push(log);
        sync(); modal.hide();
    }

    function generateReport() {
        let r = `ØªÙ‚Ø±ÙŠØ± Ù…Ø²Ø±Ø¹Ø©: ${db.farms[curFarm].name}\n------------------\n`;
        db.farms[curFarm].logs.forEach(l => r += `[${l.d}] ${l.t}: ${l.m}\n`);
        const blob = new Blob([r], {type: 'text/plain'});
        const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'ØªÙ‚Ø±ÙŠØ±_Ø§Ù„Ù…Ø²Ø±Ø¹Ø©.txt'; a.click();
    }

    function addFarm() {
        const n = prompt("Ø§Ø³Ù… Ø§Ù„Ù…Ø²Ø±Ø¹Ø©:");
        if(n) { const id = 'f'+Date.now(); db.farms[id] = { name: n, logs: [], stock: {}, reminders: [] }; sync(); location.reload(); }
    }

    function sync() { localStorage.setItem('farm_v5_db', JSON.stringify(db)); render(); }

    function render() {
        const f = db.farms[curFarm]; document.getElementById('farmNameDisplay').innerText = f.name;
        document.getElementById('logContent').innerHTML = f.logs.map(l => `
            <div class="d-flex gap-2 mb-3 border-bottom pb-2">
                ${l.img ? `<img src="${l.img}" class="log-img" onclick="window.open(this.src)">` : '<div class="bg-light p-3">ğŸš«</div>'}
                <div><b>${l.t}</b><br><small>${l.m}</small><br><small class="text-muted" style="font-size:10px">${l.d}</small></div>
            </div>
        `).reverse().join('');
        
        const sel = document.getElementById('farmSelector');
        sel.innerHTML = Object.keys(db.farms).map(id => `<option value="${id}" ${id==curFarm?'selected':''}>${db.farms[id].name}</option>`).join('');
    }

    function changeFarm() { curFarm = document.getElementById('farmSelector').value; render(); }

    getWeather(); render();
</script>
</body>
</html>
