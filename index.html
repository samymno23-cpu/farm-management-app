<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Olive Farm Pro V10 - Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ù…Ø®Ø²Ù†ÙŠ</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root { --main: #2d5a27; --accent: #d4a017; }
        body { 
            background: url('https://images.unsplash.com/photo-1500382017468-9049fee74a62?ixlib=rb-4.0.3&auto=format&fit=crop&w=1920&q=80') no-repeat center center fixed; 
            background-size: cover; font-family: 'Segoe UI', sans-serif; padding-bottom: 80px;
        }
        .overlay { background: rgba(248, 253, 248, 0.92); min-height: 100vh; }
        .top-bar { background: linear-gradient(135deg, var(--main), #1b3a18); color: white; padding: 20px; border-radius: 0 0 30px 30px; position: relative; }
        .btn-action { border: none; border-radius: 20px; padding: 18px 5px; color: white; display: flex; flex-direction: column; align-items: center; gap: 8px; font-weight: bold; box-shadow: 0 4px 8px rgba(0,0,0,0.2); }
        .bottom-nav { background: white; padding: 12px; position: fixed; bottom: 0; width: 100%; display: flex; justify-content: space-around; border-top: 1px solid #ddd; z-index: 1000; }
        .card-custom { background: white; border-radius: 20px; border: none; box-shadow: 0 4px 10px rgba(0,0,0,0.05); margin-bottom: 12px; padding: 12px; }
        .stock-tag { background: #e8f5e9; color: var(--main); padding: 2px 8px; border-radius: 10px; font-size: 0.8rem; font-weight: bold; }
    </style>
</head>
<body>
<div class="overlay">
    <div class="top-bar text-center">
        <div class="d-flex justify-content-center align-items-center gap-2">
            <h4 id="farmTitle" class="fw-bold mb-0">Ù…Ø²Ø±Ø¹Ø© Ø§Ù„Ø²ÙŠØªÙˆÙ†</h4>
            <button class="btn btn-sm btn-light rounded-circle" onclick="openMap()" title="Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ù…Ø²Ø±Ø¹Ø©">ğŸ“</button>
        </div>
        <small id="weatherText"><i class="fas fa-sun"></i> Ø¬Ø§Ø±ÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø·Ù‚Ø³ ÙˆØ§Ù„Ù…ÙˆÙ‚Ø¹...</small>
    </div>

    <div class="container mt-4 px-3">
        <div class="row g-2 mb-4 text-center">
            <div class="col-6"><div class="card-custom border-bottom border-success border-4"> <small class="text-muted">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø­ØµÙˆÙ„</small> <h4 id="viewKg" class="mb-0 text-success fw-bold">0</h4> <small>ÙƒØ¬Ù…</small> </div></div>
            <div class="col-6"><div class="card-custom border-bottom border-primary border-4"> <small class="text-muted">Ø£ØµÙ†Ø§Ù Ø§Ù„Ù…Ø®Ø²Ù†</small> <h4 id="viewStockCount" class="mb-0 text-primary fw-bold">0</h4> <small>ØµÙ†Ù</small> </div></div>
        </div>

        <div class="row g-3">
            <div class="col-4"><button class="btn-action w-100" style="background:#27ae60" onclick="openInput('Ø±ÙŠ')"><i class="fas fa-droplet fs-4"></i> Ø±ÙŠ</button></div>
            <div class="col-4"><button class="btn-action w-100" style="background:#f39c12" onclick="openInput('ØªØ³Ù…ÙŠØ¯')"><i class="fas fa-flask fs-4"></i> ØªØ³Ù…ÙŠØ¯</button></div>
            <div class="col-4"><button class="btn-action w-100" style="background:#3498db" onclick="openInput('Ø±Ø´')"><i class="fas fa-wind fs-4"></i> Ø±Ø´</button></div>
            <div class="col-4"><button class="btn-action w-100" style="background:#e74c3c" onclick="openInput('Ø£Ø¹Ø·Ø§Ù„')"><i class="fas fa-tools fs-4"></i> Ø£Ø¹Ø·Ø§Ù„</button></div>
            <div class="col-4"><button class="btn-action w-100" style="background:#2c3e50" onclick="openInput('Ø­ØµØ§Ø¯')"><i class="fas fa-box-open fs-4"></i> Ø­ØµØ§Ø¯</button></div>
            <div class="col-4"><button class="btn-action w-100" style="background:#8e44ad" onclick="openInput('Ø¹Ù…Ø§Ù„Ø©')"><i class="fas fa-users fs-4"></i> Ø¹Ù…Ø§Ù„Ø©</button></div>
        </div>

        <div class="mt-4 pb-5">
            <h6 class="fw-bold mb-3">ğŸ“œ Ø¢Ø®Ø± Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª:</h6>
            <div id="logList"></div>
        </div>
    </div>
</div>

<div class="modal fade" id="mainModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered mx-3">
        <div class="modal-content shadow-lg border-0">
            <div class="modal-header border-0 pb-0"><h5 id="mLabel" class="fw-bold"></h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
            <div class="modal-body" id="mBody"></div>
            <div class="px-3 pb-3">
                <input type="file" id="mFile" class="form-control mb-3" accept="image/*">
                <button class="btn btn-success w-100 py-3 fw-bold rounded-4" onclick="saveData()">Ø­ÙØ¸ ÙˆØ¥ØªÙ…Ø§Ù… Ø§Ù„Ø¹Ù…Ù„ÙŠØ©</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="stockModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered mx-3">
        <div class="modal-content">
            <div class="modal-header"><h5 class="fw-bold">ğŸ  Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø®Ø²Ù†</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
            <div class="modal-body">
                <h6>Ø¥Ø¶Ø§ÙØ© ØµÙ†Ù Ø¬Ø¯ÙŠØ¯/ÙƒÙ…ÙŠØ©:</h6>
                <div class="input-group mb-3">
                    <input type="text" id="sName" class="form-control" placeholder="Ø§Ø³Ù… Ø§Ù„Ø³Ù…Ø§Ø¯/Ø§Ù„Ù…Ø§Ø¯Ø©">
                    <input type="number" id="sQty" class="form-control" placeholder="Ø§Ù„ÙƒÙ…ÙŠØ©">
                    <button class="btn btn-primary" onclick="addToStock()">Ø¥Ø¶Ø§ÙØ©</button>
                </div>
                <hr>
                <h6>Ø§Ù„ÙƒÙ…ÙŠØ§Øª Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ© Ø­Ø§Ù„ÙŠØ§Ù‹:</h6>
                <div id="stockDetailsList" class="list-group"></div>
            </div>
        </div>
    </div>
</div>

<div class="bottom-nav shadow">
    <button class="btn text-success" onclick="location.reload()"><i class="fas fa-home fs-4"></i></button>
    <button class="btn text-secondary" onclick="showStock()"><i class="fas fa-warehouse fs-4"></i></button>
    <button class="btn text-secondary" onclick="downloadReport()"><i class="fas fa-file-pdf fs-4"></i></button>
    <button class="btn text-secondary" onclick="resetData()"><i class="fas fa-redo-alt fs-4"></i></button>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    let db = JSON.parse(localStorage.getItem('farm_v10_db')) || {
        cur: 'f1',
        farms: { 'f1': { name: "Ù…Ø²Ø±Ø¹Ø© Ø§Ù„Ø²ÙŠØªÙˆÙ†", logs: [], kg: 0, stock: {}, lat: null, lon: null } }
    };
    const mModal = new bootstrap.Modal(document.getElementById('mainModal'));
    const sModal = new bootstrap.Modal(document.getElementById('stockModal'));
    let curType = '';

    function openInput(type) {
        curType = type; document.getElementById('mLabel').innerText = "ØªØ³Ø¬ÙŠÙ„: " + type;
        const body = document.getElementById('mBody'); body.innerHTML = '';
        const f = db.farms[db.cur];

        if(type === 'ØªØ³Ù…ÙŠØ¯') {
            let options = Object.keys(f.stock).map(k => `<option value="${k}">${k} (Ù…ØªØ§Ø­: ${f.stock[k]})</option>`).join('');
            body.innerHTML = `
                <label class="small fw-bold">Ø§Ø®ØªØ± Ø§Ù„Ø³Ù…Ø§Ø¯ Ù…Ù† Ø§Ù„Ù…Ø®Ø²Ù†:</label>
                <select id="vSelect" class="form-select mb-2">${options || '<option>Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø£ØµÙ†Ø§Ù ÙÙŠ Ø§Ù„Ù…Ø®Ø²Ù†</option>'}</select>
                <input type="number" id="vQty" class="form-control" placeholder="Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ù…Ø±Ø§Ø¯ Ø§Ø³ØªØ®Ø¯Ø§Ù…Ù‡Ø§">`;
        } else if(type === 'Ø­ØµØ§Ø¯') {
            body.innerHTML = `<input type="number" id="v1" class="form-control" placeholder="Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ù…Ù‚Ø·ÙˆÙØ© (ÙƒØ¬Ù…)">`;
        } else if(type === 'Ø¹Ù…Ø§Ù„Ø©') {
            body.innerHTML = `<input type="text" id="v1" class="form-control mb-2" placeholder="Ø§Ø³Ù… Ø§Ù„Ø¹Ø§Ù…Ù„"><select id="v2" class="form-select"><option>Ø­Ø¶ÙˆØ± âœ…</option><option>Ø¥Ø¬Ø§Ø²Ø© ğŸ–ï¸</option></select>`;
        } else {
            body.innerHTML = `<textarea id="v1" class="form-control" rows="3" placeholder="ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©..."></textarea>`;
        }
        mModal.show();
    }

    function saveData() {
        const f = db.farms[db.cur];
        let msg = "";
        
        if(curType === 'ØªØ³Ù…ÙŠØ¯') {
            const item = document.getElementById('vSelect').value;
            const qty = parseFloat(document.getElementById('vQty').value || 0);
            if(f.stock[item] >= qty) {
                f.stock[item] -= qty;
                msg = `ØªØ³Ù…ÙŠØ¯ Ø¨Ù€ ${item} ØªÙ… Ø®ØµÙ… ${qty} ÙƒØ¬Ù… (Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ: ${f.stock[item]})`;
            } else { alert("Ø¹Ø°Ø±Ø§Ù‹ØŒ Ø§Ù„ÙƒÙ…ÙŠØ© ÙÙŠ Ø§Ù„Ù…Ø®Ø²Ù† Ù„Ø§ ØªÙƒÙÙŠ!"); return; }
        } else if(curType === 'Ø­ØµØ§Ø¯') {
            const val = parseFloat(document.getElementById('v1').value || 0);
            f.kg += val; msg = `Ø­ØµØ§Ø¯ ÙƒÙ…ÙŠØ© ${val} ÙƒØ¬Ù…`;
        } else if(curType === 'Ø¹Ù…Ø§Ù„Ø©') {
            msg = document.getElementById('v1').value + " (" + document.getElementById('v2').value + ")";
        } else { msg = document.getElementById('v1').value; }

        const log = { d: new Date().toLocaleString('ar-EG'), t: curType, m: msg, img: null };
        const file = document.getElementById('mFile').files[0];
        if(file) {
            const reader = new FileReader();
            reader.onload = e => { log.img = e.target.result; finish(f, log); };
            reader.readAsDataURL(file);
        } else finish(f, log);
    }

    function finish(f, log) { f.logs.push(log); sync(); mModal.hide(); render(); }

    function showStock() {
        const f = db.farms[db.cur];
        document.getElementById('stockDetailsList').innerHTML = Object.keys(f.stock).map(k => `
            <div class="list-group-item d-flex justify-content-between align-items-center">
                ${k} <span class="badge bg-success rounded-pill">${f.stock[k]} ÙˆØ­Ø¯Ø©</span>
            </div>
        `).join('') || "Ø§Ù„Ù…Ø®Ø²Ù† ÙØ§Ø±Øº Ø­Ø§Ù„ÙŠØ§Ù‹";
        sModal.show();
    }

    function addToStock() {
        const name = document.getElementById('sName').value;
        const qty = parseFloat(document.getElementById('sQty').value || 0);
        if(name) {
            const f = db.farms[db.cur];
            f.stock[name] = (f.stock[name] || 0) + qty;
            sync(); showStock(); render();
            document.getElementById('sName').value = ''; document.getElementById('sQty').value = '';
        }
    }

    function openMap() {
        if(db.farms[db.cur].lat) {
            window.open(`https://www.google.com/maps?q=${db.farms[db.cur].lat},${db.farms[db.cur].lon}`);
        } else { alert("Ø¬Ø§Ø±ÙŠ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹ØŒ ÙŠØ±Ø¬Ù‰ ØªÙØ¹ÙŠÙ„ GPS"); }
    }

    function render() {
        const f = db.farms[db.cur];
        document.getElementById('farmTitle').innerText = f.name;
        document.getElementById('viewKg').innerText = f.kg;
        document.getElementById('viewStockCount').innerText = Object.keys(f.stock).length;
        document.getElementById('logList').innerHTML = f.logs.map(l => `
            <div class="card-custom d-flex gap-3 align-items-center">
                ${l.img ? `<img src="${l.img}" style="width:50px;height:50px;border-radius:10px;object-fit:cover">` : '<div style="width:50px;height:50px;background:#f0f0f0;border-radius:10px;text-align:center;padding-top:12px">ğŸŒ±</div>'}
                <div class="flex-grow-1"><div class="fw-bold small text-success">${l.t}</div><div class="small">${l.m}</div><div style="font-size:9px" class="text-muted">${l.d}</div></div>
            </div>
        `).reverse().join('');
    }

    function sync() { localStorage.setItem('farm_v10_db', JSON.stringify(db)); }
    function resetData() { if(confirm("Ù‡Ù„ ØªØ±ÙŠØ¯ Ù…Ø³Ø­ Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ù…Ø²Ø±Ø¹Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©ØŸ")) { db.farms[db.cur].logs = []; sync(); render(); } }
    
    function downloadReport() {
        let t = `ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù…Ø²Ø±Ø¹Ø©\n` + db.farms[db.cur].logs.map(l => `${l.d}: ${l.t} - ${l.m}`).join('\n');
        const a = document.createElement('a'); a.href = URL.createObjectURL(new Blob([t])); a.download = 'Report.txt'; a.click();
    }

    navigator.geolocation.getCurrentPosition(p => {
        db.farms[db.cur].lat = p.coords.latitude;
        db.farms[db.cur].lon = p.coords.longitude;
        fetch(`https://api.open-meteo.com/v1/forecast?latitude=${p.coords.latitude}&longitude=${p.coords.longitude}&current_weather=true`)
        .then(r => r.json()).then(d => document.getElementById('weatherText').innerHTML = `ğŸ“ Ù…ÙˆÙ‚Ø¹Ùƒ Ù…Ø³Ø¬Ù„ | Ø§Ù„Ø­Ø±Ø§Ø±Ø©: ${d.current_weather.temperature}Â°C`);
    });

    render();
</script>
</body>
</html>
